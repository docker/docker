#!/usr/bin/env bash
set -e

source "${MAKEDIR}/.binary-setup"

copy_binaries() {
	local dir="$1"
	local hash="$2"
	# Add nested executables to bundle dir so we have complete set of
	# them available, but only if the native OS/ARCH is the same as the
	# OS/ARCH of the build target
	if [ "$(go env GOOS)/$(go env GOARCH)" != "$(go env GOHOSTOS)/$(go env GOHOSTARCH)" ]; then
		return
	fi
	if [ ! -x /usr/local/bin/${RUNC_BINARY_NAME} ]; then
		return
	fi
	echo "Copying nested executables into $dir"
	for file in ${RUNC_BINARY_NAME} ${CONTAINERD_BINARY_NAME} ${CONTAINERD_CTR_BINARY_NAME} ${CONTAINERD_SHIM_BINARY_NAME} ${PROXY_BINARY_NAME} ${INIT_BINARY_NAME}; do
		cp -f `which "$file"` "$dir/"
		if [ "$hash" == "hash" ]; then
			hash_files "$dir/$file"
		fi
	done
}

[ -z "$KEEPDEST" ] && rm -rf "$DEST"
source "${MAKEDIR}/.binary"
copy_binaries "$DEST" 'hash'
