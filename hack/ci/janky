#!/usr/bin/env bash
# Entrypoint for jenkins janky CI build

# FixMe
# set -eu -o pipefail

# Rebase to master so codecov will provide valid coverage diff report
reverse () {
    local out=()
    while [ $# -gt 0 ]; do
        out=("$1" "${out[@]}")
        shift 1
    done
    echo "${out[@]}"
}

source hack/validate/.validate
COMMITS=( $(validate_log --format='format:%H%n' --no-merges) )
COMMITS_ON_ORDER=$(reverse "${COMMITS[@]}")

git config --global user.email "ci@moby"
git config --global user.name "CI"
git fetch origin master
# Using last non-merge commit (codecov is not run on merge commits)
GIT_MASTER_COMMIT=$(git rev-list --no-merges -n 1 origin/master)
git checkout master
echo Using master commit: $GIT_MASTER_COMMIT as base
git reset --hard $GIT_MASTER_COMMIT

echo "${COMMITS_ON_ORDER[@]}" | xargs -n 1 git cherry-pick

hack/validate/default
hack/test/unit

JENKINS_URL=https://jenkins.dockerproject.org \
bash <(curl -s https://codecov.io/bash) \
    -f coverage.txt \
    -C "$GIT_SHA1" -Z

# FixME: Just save some time during debug
exit 0

hack/make.sh \
	binary-daemon \
	dynbinary \
	test-docker-py \
	test-integration-flaky \
	test-integration \
	cross
